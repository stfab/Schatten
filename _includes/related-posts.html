<div class="related">
  <h2>Related Posts</h2>
  {% assign related_posts = site.posts | where:"categories", page.categories %}
  {% if related_posts.size == 0 %}
    {% assign related_posts = site.posts | where:"tags", page.tags %}
  {% endif %}
  {% if related_posts.size == 0 %}
    {% assign related_posts = site.posts | sort: 'date' | reverse | limit: 3 %}
  {% endif %}
  {% for post in related_posts limit:3 %}
    {% include post-preview.html %}
  {% endfor %}
</div>